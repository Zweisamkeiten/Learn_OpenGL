# 基础光照

OpenGL的光照使用的是简化的模型。对现实的情况进行近似。
这些光照模型都是基于对光的物理特性的理解。

其中一个模型是冯氏光照模型。(Phong Lighting Model)

冯氏光照模型的主要结构由三个分量组成:

1. 环境(Ambient)光照
2. 漫反射(Diffuse)光照
3. 镜面(Specular)光照

- `环境光照`即使在黑暗的情况下，世界上仍有一些光亮，所以物体几乎永远不会是完全黑暗的 为模拟这个，使用一个环境光照变量，永远会给物体一些颜色
- `漫反射光照`模拟光源对物体方向性影响 他是冯氏光照模型中视觉上最为显著的分量 物体的某一部分越是正对着光源 它就会越亮
- `镜面光照` 模拟有光泽物体上面出现的亮点 镜面光照的颜色相比于物体的颜色更倾向于光的颜色

## 环境光照

光通常都不是来自于同一个光源，而是来自于我们周围分散的很多光源

光的一个属性可以向很多方向发散并反弹 从而能够到达不是非常直接临近的点 因此光能够在其他的表面上反射 对一个物体产生间接的影响

考虑到这种情况的算法叫做全局光照算法，这种算法开销高昂又十分复杂

简化的全局照明模型 环境光照

使用一个很小的常量光照颜色 添加到物体片段着色器中的最终颜色中

用光的颜色乘以一个很小的常量环境因子 再乘以物体的颜色 将最终结果作为片段的颜色

```glsl
void main()
{
    float ambientStrength = 0.1;
    vec3 ambient = ambientStrength * lightColor;

    vec3 result = ambient * objectColor;
    FragColor = vec4(result, 1.0f);
}
```

## 漫反射光照

漫反射光照对物体产生显著的视觉影响

漫反射光照使物体上与光线方向越接近的片段能从光源处获得更多的亮度

某处有个光源，它所发出的光线落在物体的一个片段上

需要测量的是光线是以什么角度接触到这个片段的

如果光线垂直于物体表面 这束光对物体的影响会最大化

为测量光线与片段的角度 使用一个`法向量`(垂直于片段表面的一个向量)

计算漫反射光照需要什么

- 法向量: 一个垂直于顶点表面的向量
- 定向的光线： 作为光源的位置与片段的位置之间向量差的方向向量

## 法向量

垂直于顶点表面的单位向量。由于顶点本身没有表面，只是通过几个周围的顶点来计算出顶点的表面。

使用叉乘对立方体所有的顶点计算法向量。由于3d立方体不是复杂形状，可以简单地把法线数据手工添加到顶点数据中。

## 最后一件事

现在已经将法向量从顶点着色器传到片段着色器。目前片段着色器里的计算都是世界空间坐标中进行的

因此应该将法线向量也转换为世界空间坐标 但是这不是简单地将它乘以一个模型矩阵就能够搞定的

首先法向量只是一个方向向量 不能表达空间中的特定位置。

同时，法线向量没有齐次坐标(定点位置中的w分量)

这意味着，位移不应该影响到法向量。因此 如果把法向量乘以一个模型矩阵 就要从矩阵中移除位移部分.只选用模型矩阵左上角3x3的矩阵

也可以将法向量的w分量设置为0 再乘以4x4 矩阵 这样可以移除位移。对于法向量，只希望对其实施缩放和旋转变换

另外，如果模型矩阵执行了`不等比缩放`。顶点的改变会导致法向量不再垂直于表面。

等比缩放不会破坏法线，因为发现方向没被改变，仅仅改变了法线的长度，这可以通过标准化来修复。

当应用一个不等比缩放时，法向量就不会再垂直于对应的表面了，导致破坏光照。

解决问题的方法是使用一个专为法向量定制的模型矩阵。
这个矩阵称为法线矩阵。(Normal Matrix)使用一些线性代数操作来移除对法向量错误缩放的影响。

法线矩阵被定义为`模型矩阵左上角的逆矩阵的转置矩阵`。大部分的资源都会将法线矩阵定义为应用到模型观察矩阵(Model-view Matrix)上的操作，但是由于现只在世界空间中进行操作，所以只使用模型矩阵

在顶点着色器中，可以使用`inverse`和`transpos`函数自己生成法线矩阵。
这两个函数对所有类型矩阵都有效。需要注意要将处理过的矩阵强制转换为3x3矩阵 来保证失去位移属性以及能够乘以vec3的法向量

```glsl
Normal = mat3(transpos(inverse(model))) * aNormal;
```

在漫反射光照部分,并没有对物体本身执行任何缩放操作，所以这里要将法线向量转换到世界空间的话，只乘以模型矩阵也是可以的。但是，如果进行了不等比缩放，就必须要使用法线矩阵去乘以法向量。

对于着色器，逆矩阵是一个开销较大的运算。因此，尽可能在着色器中避免进行逆矩阵运算。 因为它必须对场景中的每个定点都进行这样的处理。

对于一个对效率有要求的应用，在绘制前最好用CPU计算出法线矩阵，然后通过unifor把值传给着色器。

## 镜面反射

Specular Hightlight

与漫反射相同，镜面反射也是依据光的方向向量与物体的法向量来决定的，但是它也依赖于观察方向。例如，观察者从什么方向看着这个片段的。

镜面光照是基于，光的反射特性，想象物体表面像一面镜子一样

通过反射 法向量 周围光的出方向来计算反射向量。 然后计算反射向量与视线方向的角度差，如果夹角越小，那么镜面光的影响就会越大
.作用效果就是去看光被物体所反射的那个方向，会看到一个高光。

观察向量是镜面光照附加的一个变量，可以使用观察者世界空间位置和片段的位置来计算它。再计算镜面光强度，乘以光源颜色，在加上环境光与漫反射分量。

## 总结

光照着色器早期，开发者曾在顶点着色器中实现冯氏光照模型。顶点着色器中做光照的优势，相比片段来说，顶点要少的多，因此会更高效，，所以开销较大的光照计算频率会更低。然而，顶点着色器中的最终颜色值仅仅是顶点的颜色值。

片段的颜色值是由插值光照颜色所得来的，结果导致这中光照十分不真实。

在顶点着色器中实现的冯氏光照模型叫做Gouraud着色，而不是冯式着色
。由于插值，这种光照有些逊色。冯式着色能产生更平滑的光照效果。
